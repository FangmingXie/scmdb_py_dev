{%- extends "base.html" %} {% import "bootstrap/utils.html" as utils %} {% block content %}
<div class="container">
    {%- with messages = get_flashed_messages(with_categories=True) %} {%- if messages %}
    <div class="row">
        <div class="col-md-12">
            {{utils.flashed_messages(messages)}}
        </div>
    </div>
    {%- endif %} {%- endwith %}
    <div class="col-md-12">
        <div class="panel panel-info" id="options-panel">
            <div class="panel-heading">
                <div class="panel-title">
                    <h5>Search<a data-toggle="collapse" title="" data-placement="left" class="btn btn-sm btn-danger pull-right" style="margin-top: 0px;" data-original-title="Collapse Search Options" href="#search-panel-body"><span class="glyphicon glyphicon-resize-small"></span></a>
                    <a href="#" target="_blank" id="epiBrowserLink" class="btn btn-sm btn-info disabled pull-right" style="margin-top: 0px; margin-right:10px" role="button">
                        <small style="color:white;">Epigenome browser (AnnoJ)</small>
                    </a>
                    </h5>
                </div>
            </div>
            <div class="panel-body collapse in" id="search-panel-body" style="padding-top:10px;">
                {% include "components/search_options.html" %}
            </div>
        </div>
    </div>
    <div style="position:relative; left:0; z-index:2;">
        <div class="col-md-12 col-sm-12">
            <div class="panel panel-default panel-main" style="overflow-x: auto; margin-left:auto; margin-right:auto;">
                <div class="panel-heading">
                    <div class="panel-title"><b>{{ species }}</b> Clustering{% if gene is defined %} - {{ gene }}{% endif %}
                        <a data-toggle="collapse" title="" data-placement="left" href="#cluster_plots" class="btn btn-sm btn-basic pull-right" style="margin-top: 0px;" data-original-title="Collapse Search Options"><span class="glyphicon glyphicon-resize-small"></span></a>
                        <a data-toggle="collapse" title="" data-placement="left" href=".cluster_options_group" class="btn btn-sm btn-basic pull-right" style="margin-top: 0px;" data-original-title="Collapse Search Options"><span class="glyphicon glyphicon-cog"></span></a>
                    </div>
                </div>
                <div class="panel-collapse collapse in" id="cluster_plots">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6 col-sm-12" id="tSNE_cluster_div" style="padding: 0px">
                                {% include "components/tsne_cluster.html" %}
                            </div>
                            <div class="col-md-6 col-sm-12" id="methyl_scatter_div" style="padding: 0px">
                                {% include "components/mch_cluster.html" %}
                            </div>
                        <div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-12" style="position:relative; z-index:2;">
        <div class="panel panel-default panel-main" style="overflow-x: auto; margin-left:auto; margin-right:auto; display:none;" id="methyl_graphs_div">
            <div class="panel-heading">
                <div class="panel-title">
                    Gene methylation level{% if gene is defined %} - {{ gene }}{% endif %}
                    <a data-toggle="collapse" title="" data-placement="left" href="#mch_box" class="btn btn-sm btn-basic pull-right" style="margin-top: 0px;" data-original-title="Collapse Search Options"><span class="glyphicon glyphicon-resize-small"></span></a>
                </div>
            </div>
            <div class="panel-collapse collapse in" id="mch_box">
                <div class="panel-body">
                    <div class="col-md-9">
                        {% include "components/mch_box.html" %}
                    </div>
                    <div class="col-md-3">
                        {% include "components/mch_table.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{%- endblock %} {% block scripts %} {{super()}}

<script src="./static/plotly.min.js"></script>
<script src="./static/customview.js" type="text/javascript"></script>
<link href="./static/datatables.min.css" rel="stylesheet" />
<script src="./static/datatables.min.js"></script>
<link href="./static/bootstrap-toggle.min.css" rel="stylesheet" />
<script src="./static/bootstrap-toggle.min.js"></script>
<link href="./static/select2.min.css" rel="stylesheet" />
<script src="./static/select2.min.js"></script>
<link href="./static/bootstrap-slider.min.css" rel="stylesheet" />
<script src="./static/bootstrap-slider.min.js"></script>

<script>
    var species = "{{ species }}";
    var pSlider;
    var geneSearchCache;
    var mmu_gID;
    var hsa_gID;
    var grouping;
    var buttons;

    $(document).ready(function() {
        $('[data-toggle="popover"]').popover();
        $('#outlierToggle').bootstrapToggle();
        $('#orthologsToggle').bootstrapToggle();
        $('#orthologsToggle').bootstrapToggle('disable');
        //$('#toggle-3d').bootstrapToggle('disable');

        loadClusterPlots();
        randomizeClusterColors();
        initGeneNameSearch();
        $('#geneTable').DataTable();
        initDataTableClick();

        // Percentile changes are handled separately, as every change would result in a plot update, but we want
        // this to happen when sliding is actually stopped.
        pSlider = $("#percentile").slider({
            min: 0,
            max: 1,
            step: 0.05,
            value: [0.05, 0.95],
            tooltip_position: 'bottom'
        }).on('slideStop', updateGeneElements).data('slider');
        buttons = document.getElementsByClassName('modebar-btn');
    });
    $("#mCHLevelCol :input, #methylationTypeCol :input").change(function() {
        updateGeneElements();
    });

    $("#gene-search-btn").click(function() {
        updateGeneElements();
    });

    //wait for resizing to end, then reset axes.
    var resizeTimer;
    $(window).on('resize', function(e) {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if($("#geneName").select2('data').length > 0){  //if one or more genes have been selected
                if($('#cluster_plots').hasClass("in")){
                    try{
                        buttons[8].click(); //button for autoscaling tsne_cluster
                        buttons[20].click();  //button for autoscaling mch_cluster
                    }
                    catch(err) {
                        console.log(err);
                    }
                }
                if($('#mch_box').hasClass("in")){
                    try{
                        buttons[32].click();  //button for autoscaling mch_box/heatmap
                    }
                    catch(err) {
                        console.log(err);
                    }
                }
            }
            else{
                if($('#cluster_plots').hasClass("in")){
                    try{
                        buttons[8].click();  //button for autoscaling tsne_cluster
                    }
                    catch(err) {
                        console.log(err);
                    }
                }
            }
        }, 250);
    });

    $('#clear-btn').click(function() {
        geneNameSelector.val(null).trigger("change");
        $('#gene-search-btn').click();
    });

    $("#outlierToggle, #orthologsToggle").change(function() {
        updateMCHBoxPlot();
    });

    $("#toggle-3d").change(function() {
        display3DPlotToggle();
    });

    $("#tsneGrouping :input").change(function() {
        loadClusterPlots();
    });

</script>
{% endblock %}
